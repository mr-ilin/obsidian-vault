# План
1. Вступление
	1. Какую проблему решаем
2. Оbservability
	1. Что такое и зачем
	2. Логи
	3. Метрики
	4. Трейсы
	5. Метрики vs Логи
3. Устройство мониторинга в ДомКлик
	1. Инструменты мониторинга
	2. VictoriaMetrics
	3. Grafana
	4. Бекенд-сервис
4. Технические метрики
	1. SLI SLO SLA
	2. Алерт Метрика
5. Создаем метрики мечты
6. Алертинг
	1. ...
	2. 

7. Four golden signals

- [ ] Нумерация слайдов
- [x] Метрика из книги
- [ ] AppMetrica нет алертов норм

# Вступление

Бэкенд-сервисы давно используют продвинутые системы мониторинга и наблюдаемости, что позволяет обеспечивать их стабильность и высокую производительность. Однако наблюдаемость важна не только для серверной части: в условиях высокой конкуренции и требований пользователей к качеству мобильных приложений, особенно важно следить за стабильностью и производительностью клиентских приложений. Плохая производительность или частые сбои могут привести к тому, что пользователи удаляют приложение, что наносит ущерб репутации и пользовательской базе.

Эти вызовы подчеркивают необходимость комплексного подхода к мониторингу и поддержке приложений, который выходит за рамки простого логирования ошибок. Здесь на помощь приходит концепция наблюдаемости (Observability), позволяющая глубже понять, что происходит внутри системы, и быстрее находить и устранять проблемы.

# План

Цель данного доклада – рассмотреть, как подходы наблюдаемости могут применяться к мобильным приложениям, какие инструменты и методологии наиболее эффективны и как правильно организовать сбор данных, чтобы обеспечить стабильную и производительную работу приложений. Мы обсудим, как организована система мониторинга в ДомКлик, какие технические метрики важно учитывать и как грамотно настроить сбор метрик для своевременного реагирования на возможные проблемы.

# SRE
SRE (Site Reliability Engineering) — это сфера обеспечения бесперебойной работы высоконагруженных сервисов. Соответственно, SRE-инженер — это специалист по надёжности.

Термин SRE придумали в Google, в этой компании появились первые разработчики, которые затачивают свою работу на безотказность и быстрое исправление ошибок. И сам Google развивает это направление, есть ряд книг представленных на слайде, посвященных как самому SRE, так и практике внедрения данных концепций.

Основные задачи включают мониторинг и автоматизацию процессов, управление инцидентами, установку целей уровня обслуживания и постоянное улучшение производительности систем. Введение SRE-практик позволяет минимизировать ручные процессы и создавать баланс между новыми функциями и стабильностью.

В рамках доклада, мы не будем рассматривать все принципы, а остановимся только на необходимых. Однако вы всегда можете ознакомится с ними самостоятельно, используя представленную литературу.

# Observability
Observability (наблюдаемость) — это способность системы предоставлять достаточный объем информации о своем внутреннем состоянии для эффективного мониторинга, диагностики и устранения неполадок. Изначально эта концепция пришла из инженерии управления системами, но сейчас активно используется в IT для обеспечения устойчивости и производительности программных продуктов.
## Что такое и зачем
Наблюдаемость нужна для того, чтобы команда разработки могла быстро понять, что происходит внутри приложения, и оперативно реагировать на проблемы. В идеале, это система, которая позволяет не просто фиксировать сбои, а глубоко анализировать, откуда они берутся и как их исправить.

Примеры плохой наблюдаемости могут быть самыми показательными. 

Например, приходит Vice CTO Дима Чебнев и говорит: "У меня не работают звонки". Казалось бы, ситуация критическая, еще и повторяется у твоего Итала, но алерта по ключевой ручке, отвечающей за подмену звонков, никто не получил, значит плохая наблюдаемость. А вот хорошие и понятные графики с настроенными алертами - показатель хорошей наблюдаемости.

Или другой случай, уже гипотетический: прилетает тикет из help deks, пользователь сталкивается с ошибкой при запуске приложения, а у нас нет логов, чтобы понять, что произошло. В итоге команда собирается и пытается воспроизвести проблему вручную, тратя время и силы, вместо того чтобы сразу иметь перед глазами четкие данные о происходящем в виде логов нашего клиента.

Такие примеры подчеркивают, что без хорошей системы наблюдаемости проблемы остаются неуловимыми, а их диагностика превращается в хаотичный процесс угадываний и проверок.
## Логи

Рассмотрим 3 столба Наблюдаемости

Логи — это записи событий в приложении, которые помогают отслеживать его поведение и выявлять ошибки. Они бывают двух видов: те, что отправляются на сервер в режиме реального времени - онлайн-логи, и те, что собираются локально и передаются по запросу (on-demand).

Онлайн-логи обеспечивают оперативное наблюдение за работой приложения, хранят тех, информацию, отправляются на сервер почти сразу, как событие случилось. Не можем писать много и подробно тк дорого хранить и отправлять, 90% лежит просто так

On-demand-логи могут включать более детальную информацию, хранятся на телефоне клиента, и отправляются при необходимости, что полезно для диагностики сложных проблем.
## Метрики
Метрики — это количественные показатели, описывающие состояние и производительность системы или приложения. Они помогают отслеживать ключевые аспекты работы, такие как загрузка CPU, использование памяти, время отклика, количество запросов в секунду, процент ошибок и многое другое. С помощью метрик можно получить ясное представление о поведении системы, выявить узкие места и аномалии, а также оценить, насколько текущая производительность соответствует заданным целям и ожиданиям.
## Трейсы
Трейсы (или трассировка) — это инструмент, позволяющий отслеживать прохождение запроса через различные компоненты распределенной системы. Они помогают понять, как данные перемещаются между сервисами и где происходят задержки или сбои. Каждый трейс представляет собой последовательность событий, связанных с выполнением одной операции, и включает временные метки, чтобы можно было определить, сколько времени занимает каждый шаг.

Трейсы особенно полезны для анализа сложных цепочек вызовов в микросервисной архитектуре, где один запрос может задействовать несколько разных сервисов. В текущем докладе мы их не будем рассматривать.
## Метрики vs Логи
Метрики — это структурированные числовые данные, которые легко агрегировать и визуализировать. Логи, наоборот, представляют собой текстовые записи событий с произвольным форматом, которые могут включать детальную информацию и контекст.

Цель метрик — предоставить обзорное понимание производительности системы и помочь в мониторинге, алертинге и выявлении аномалий. Логи нужны для детальной диагностики, поиска причин ошибок и воспроизведения проблемных сценариев.

По объему метрики компактны, так как содержат только ключевые числовые показатели. Логи, наоборот, занимают больше места, так как включают текстовую информацию и могут генерироваться в больших количествах, особенно при сложных ошибках или интенсивной работе системы.

Технические метрики
## SLI SLO SLA

Вероятно вы слышали о таких понятиях, как SLO, SLI и SLA. Рассмотрим их подробнее

**Service Level Indicator (SLI)** — количественная оценка работы сервиса, обычно связанная с удовлетворенностью бизнеса надёжностью, отзывчивостью и производительностью приложения или сервиса за определенный период времени (месяц, квартал, год). Примеры SLI:

- время загрузки экрана в миллисекундах;
- количество ошибок;
- значение CrashFree Users в %, знакомое мобильным разработчикам по Firebase.

Иными словами, SLI — это индикатор, представляющий конкретное значение в определенных единицах измерения.

**Service Level Objective (SLO)** — целевое значение нашего SLI, к которому мы стремимся. Например, у нас есть внутренняя договоренность, согласно которой CrashFree Users для приложения должен быть меньше 99,9%. Если новая версия приложения не соответствует этому порогу, мы не будем выпускать её на всех пользователей до устранения проблем, приводящих к сбоям.

**Service level agreement (SLA)** – публичное соглашение с нашими внутренними и внешними пользователями о последствиях несоблюдения SLO. Гипотетический пример: рост средней задержки выполнения поискового запроса в прайм-тайм до 500 мс влечёт за собой уплату штрафа всем партнерам, которым предоставляется сервис. Отмечу, что рассмотрение SLA выходит за данного доклада.
## Метрика

**Алерт** — уведомление о проблеме. В зависимости от важности компонента уведомления могут быть разными: от самых ненавязчивых — письма на корпоративную почту, до самых экстренных — звонков на мобильный телефон ответственного. Важно не то, куда может прийти сообщение, а то, что мы знаем, что оно придет, и разработчик его увидит. Обычно для этого используется соответствующий канал в корпоративном мессенджере.

**Метрика** — совокупность одного или нескольких SLO, отображенных на графике или графиках, позволяющая утверждать, что компонент работает корректно. Желательно, чтобы у метрики также был настроен алерт.

Необходимо удерживать себя от мысли обвесить метриками все и вся, только потому что это просто и быстро. Необходимо стремиться к тому, чтобы мониторить минимальное количество событий, но достаточное для утверждения, что «проверяемый сценарий работает». Иными словами, метрика не должна отвечать на вопрос «В какой части компонента возникла проблема?», но должна сигнализировать, если компонент перестал работать должным образом. Для детальной информации нужны логи!

## Например (градусник)
Рассмотрим самый лучший по моему мнению пример метрики - это градусник

- **Метрика должна быть легко читаемой.** Градусник — это одна шкала, один показатель и простое условие: если температура >37, значит, есть проблема. Чем проще метрика, тем легче понять, соблюдаете ли вы SLO или нет.

Для алертов тоже есть хороший пример
- **Алерты должны быть стабильными.** Здесь всё как в сказке про мальчика, который кричал «Волки!». Если ваши алерты будут срабатывать, когда проблемы нет, то в случае настоящей проблемы на неё никто не обратит внимания.

## Устройство мониторинга в ДомКлик

Перейдем к рассмотрению подхода к мониторингу в Домклик

### Инструменты мониторинга
Инструменты и архитектура мониторинга в нашей компании регулируются итогами Архитектурного Комитета (АрхКом). Включают в себя следующие компоненты:

1. **Zabbix**

- Применяется для контроля доступности и состояния систем на уровне серверов и сервисов.
- Мониторинг инфраструктуры, сетевых устройств, API, облаков, сертификатов, доменов и БД.

2. **VictoriaMetrics/Prometheus**

- Основной инструмент для сбора и агрегации метрик, важных для производительности и здоровья системы.
- Мониторинг Kubernetes и сервисов в нем, сбор метрик о состоянии инфраструктуры и web-сервисов.

3. **Dynatrace/Ключ-Астром**

- Применяются для глубокой аналитики производительности приложений и диагностики ошибок.
- АPM (мониторинг приложений), веб-мониторинг и трассировка.

4. **Grafana**

- Используется для построения дашбордов и алертинга, обеспечивая наглядное представление о состоянии системы.
- Визуализация данных из различных источников (в том числе Prometheus/VictoriaMetrics и Zabbix).

Для мобильных разработчиков особенно интересны **Prometheus/VictoriaMetrics** для мониторинга сервисов и метрик, а также **Grafana** для визуализации и построения алертов.

## О сервисах
Давайте остановимся на них подробней
### VictoriaMetrics
**VictoriaMetrics** — это высокопроизводительная и масштабируемая система для сбора, хранения и обработки временных рядов. Она используется для мониторинга и хранения метрик в режиме реального времени. Основные преимущества VictoriaMetrics включают высокую скорость записи данных, эффективное использование памяти и дискового пространства, а также совместимость с инструментами Prometheus.

### Grafana
**Grafana** — это популярный инструмент для визуализации данных и создания дашбордов. Она поддерживает интеграцию с различными источниками данных, такими как Prometheus, VictoriaMetrics, Zabbix и другие, что делает ее универсальным решением для мониторинга. С помощью Grafana можно создавать настраиваемые дашборды, которые позволяют наблюдать за состоянием системы, анализировать метрики и выявлять потенциальные проблемы.

Grafana также поддерживает создание алертов, что позволяет настраивать уведомления при достижении определенных условий метрик. Интерфейс Grafana интуитивно понятен и гибок а интеграция с различными источниками данных и плагинами позволяет адаптировать Grafana под практически любые потребности команды.

### Бекенд-сервис
Бэкенд-сервис собирает данные о своей работе и состоянии (например, количество запросов, ошибки, время отклика) и предоставляет их в формате, совместимом с Prometheus.

### Мониторинг сервиса

Prometheus формат подразумевает предоставление метрик через HTTP-эндпоинт `/metrics`, где метрики представлены в виде текстовых строк с названием, значением и, при необходимости, метками (лейблами) для дополнительной информации.

VictoriaMetrics, в свою очередь, использует `vmagent` или другие сборщики данных для периодического опроса этих эндпоинтов и передачи данных в систему хранения. 

Такой подход называется скрейпинг — это процесс периодического опроса этих эндпоинтов с метриками инструментами вроде `vmagent`. Он необходим для автоматического сбора данных, обеспечивая актуальность метрик в режиме реального времени. Такой подход лучше по сравнению с push-моделью, так как снижает риск потери данных и упрощает управление системой мониторинга. Скрейпинг обеспечивает надежный сбор метрик и позволяет системе адаптироваться к изменениям нагрузки, делая мониторинг гибким и устойчивым.

## Создаем метрики мечты

## Текущие сервисы
Сначала рассмотрим сервисы метрик, которые мы уже используем в наших приложениях

### Firebase Performance

**Преимущества**:
- **Удобство интеграции**: Простое внедрение и автоматический сбор множества метрик (включая network, app start, и custom traces).
- **Готовая инфрастуктура**: Масштабируемость и надежность без необходимости настраивать собственные серверы.
- **Общий доступ к данным**: Метрики производительности могут быть использованы совместно с аналитикой, что помогает легче находить взаимосвязи между производительностью и поведением пользователей.

**Недостатки**:
- **Ограниченная кастомизация**: Функционал ограничен предустановленными шаблонами и API.
- **Планируемый отказ**: в виду рисков безопасности (санкции, блокировка, уход)

### AppMetrica

**Преимущества**:
- **Глубокая аналитику**: Охватывает не только метрики производительности, но и поведенческую аналитику.

**Недостатки**:
- **Отсутствие алертов по событиям**: Нет возможности настраивать алерты по конкретным событиям, что ограничивает гибкость мониторинга.

### Экспорт

Прежде чем перейти к рассмотрению inhouse решения возникает вопрос, можем ли мы просто экспортировать данные из этих систем и использовать в своей инфраструктуре?

Экспорт метрик в VictoriaMetrics, возможен, но имеет определенные ограничения и особенности. Вот что стоит учесть:

### 1. **Firebase Performance Monitoring**

- **Задержки и сложность**: Процесс выгрузки данных и передачи их в другую систему может быть сложным и вызывать задержки, что снижает актуальность данных для мониторинга в реальном времени.
- **Ограниченность метрик**: Далеко не все данные, собранные Firebase, могут быть экспортированы в полной мере. Некоторая информация остается доступной только через собственный интерфейс Firebase.
- **Сложная инфраструктура**: Имеем сложную инфраструктуру для обеспечения взаимодействия двух систем

### 2. **AppMetrica**

**Возможность экспорта**:

- **API и Data Export**: AppMetrica предоставляет API для выгрузки данных о пользователях, событиях и метриках, что позволяет разработать собственное решение для экспорта данных в VictoriaMetrics.
- **Файловые выгрузки**: Данные могут быть выгружены в формате CSV или JSON и затем обработаны скриптами для импорта в инфраструктуру VictoriaMetrics.

**Минусы**:

- **Ограниченные возможности экспорта**: Не все типы данных могут быть выгружены в полном объеме. 
- **Отсутствие real-time передачи**: Выгрузка данных через API или файлы не поддерживает потоковую передачу данных, что делает сложным реализацию мониторинга в реальном времени.
- **Потенциальные затраты**: Частая выгрузка и использование API могут привести к повышенным нагрузкам на систему и возможным ограничениям по количеству запросов или тарифам.

### in-house сервис (mobile-tech-metrics)

**Преимущества**:
- **Гибкость**: Полный контроль над структурой данных, форматом метрик, обработкой и визуализацией. Возможность настраивать сбор данных под любые специфичные сценарии мобильных приложений.
- **Собственная инфраструктура аналитика**: Поддержка интеграции с инфраструктурой вроде Prometheus, Grafana
- **Алерты**: Возможность настройки алертов по любым метрикам и событиям, что не всегда возможно в сторонних решениях.

**Недостатки**:
- **Затраты на разработку и поддержку**: Требует вложений в разработку и регулярное обслуживание.

Вооружившись всеми полученными знаниями, рассмотрим как подойти к проектированию метрик, выбрать ключевые показатели и интегрировать их в существующую инфраструктуру.
### Архитектура
Архитектура нашей системы метрик включает в себя

1. **iOS и Android клиенты**: Мобильные приложения на iOS и Android собирают данные о своем состоянии, могут включать информацию о производительности, ошибках, взаимодействиях пользователей и др.
2. **Библиотека аналитики на KMP (Kotlin Multiplatform)**: Основной компонент для унифицированного сбора метрик с обеих мобильных платформ - KMP библиотека CNSAnalytics. Был реализован адаптер и соответствующие ивенты.
3. **Бэкенд-сервис метрик**: Специальный сервис, принимающий данные с мобильных клиентов через API и предоставляющий их в формате, совместимом с Prometheus/VictoriaMetrics. Выступает медиатором между мобильными клиентами и инфраструктурой Домклик, поскольку нельзя просто так прийти в викторию и положить свои метрики. Сервис обрабатывает, агрегирует и отдает метрики на запросы от `vmagent`, который периодически опрашивает эндпоинты для сбора данных. Стек - Python + FastApi
5. **Инфраструктура на VictoriaMetrics**: Централизованная система для хранения и обработки временных рядов метрик, была рассмотрена раннее. 
6. **Grafana**

Эта архитектура обеспечивает полный цикл сбора и анализа метрик от клиентов до центральной инфраструктуры, предоставляя команде всем необходимые инструменты для мониторинга.

## Метрики
**Rate (Количество запросов в секунду)**  
Показатель, отражающий общий уровень активности мобильных приложений, измеряя количество запросов, отправленных за секунду. Метрика `mobile_requests_total` собирается как счетчик (Counter) и включает лейблы: url, статус-код, версия приложения и платформа.

**Errors (Количество неудачных запросов)**  
Метрика, отслеживающая число неуспешных запросов. Это производная от `mobile_requests_total`, которая позволяет выделить только ошибки. Лейблы включают url, статус-код, версию приложения и платформу.

**Duration (Время обработки запросов)**  
Метрика, отражающая время, затраченное на выполнение запросов. Используется гистограмма `mobile_requests_duration_seconds_bucket`, которая помогает анализировать распределение времени обработки. Лейблы: url, статус-код, версия приложения, платформа.

**Ошибки парсинга ответов бекенда**  
Метрика фиксирует общее количество ошибок при парсинге ответов от бэкенда. `mobile_requests_decoding_errors_total` собирается как счетчик и содержит лейблы: url, версия приложения, платформа и тип ошибки декодирования.

**Ошибки парсинга конфигов**  
Показатель общего количества ошибок при парсинге конфигурационных файлов приложения. Метрика `mobile_config_parse_errors_total` является счетчиком и включает такие лейблы, как тип конфига, версия приложения, платформа и тип ошибки декодирования.

**App Launch Time (Время запуска приложения)**  
Метрика, измеряющая время, затраченное на полное открытие приложения. `mobile_app_launch_time_seconds_bucket` собирается как гистограмма с лейблами: версия приложения и платформа.

**Screen Render Time (Время рендеринга экрана)**  
Отражает время, необходимое для полной отрисовки экранов. `mobile_screen_render_time_seconds_bucket` также собирается как гистограмма и включает лейблы: название экрана, версия приложения, платформа.

## Лейблы
**Лейблы** — это дополнительные атрибуты, которые добавляются к метрикам для детализированного описания данных. Они позволяют более точно идентифицировать источник метрики и дают возможность группировать и фильтровать данные по различным признакам, таким как `url`, `status_code`, `app_version`, `platform` и другим. Например, метрика с лейблом `status_code="500"` помогает отслеживать только ошибки сервера.

**Кардиналити (cardinality)** — это мера количества уникальных комбинаций значений лейблов в наборе метрик. Чем больше лейблов и их уникальных значений, тем выше кардиналити. Высокая кардиналити может привести к значительному увеличению объема хранимых данных и увеличению нагрузки на систему мониторинга, что снижает ее производительность и может привести к трудностям с масштабируемостью.

**Пример:**  
Если у метрики `mobile_requests_total` есть лейблы `url`, `app_version`, и каждый из них может иметь много уникальных значений, то совокупное количество всех уникальных комбинаций этих лейблов определяет кардиналити метрики. Слишком высокая кардиналити может усложнить обработку метрик и повысить требования к ресурсам хранения и вычислений.

## Заключение

Заложен фундамент для системы метрик, который помогает держать руку на пульсе мобильных приложений. Но впереди ещё много работы и возможностей для улучшений. Если у вас есть свежие идеи или желание поучаствовать в развитии — будем рады вашей помощи и вовлеченности, заходите ко мне в лс

Метрики производительности, например запуск приложения по фазам.

Следующий шаг — детально разобраться с метриками, понять, какие лейблы используются, и как максимально эффективно работать с аналитическими системами. Для этого мы подготовили ссылку на полезный курс, который поможет вам погрузиться в тему глубже.

Ну и, конечно, остаётся важный пробел — работа с логами. Это направление открыто для инициатив, так что если готовы заняться логированием и улучшением наблюдаемости, ваши усилия будут как никогда кстати.